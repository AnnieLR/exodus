
# Bazel build failures
(doc is still WIP)
So we succeeded to migrate your project to Bazel **BUT** failed to build / test it using bazel? The next guide is for you.
In this guide we will explain how to solve bazel build issues in 2 ways:
- **manual** - apply fixes on your migration branch (`bazel-mig-*`) ([how to run bazel locally](running-bazel-locally.adoc))
- **automatic** - Make sure that migrator generates BUILD.bazel files that fix the problem automatically **on next migrations**, by providing hints / overrides.

We recommend first checking the manual solution locally (you can also push the fix and re-run jenkins). If that works well, apply the automatic solution.
***
## Background and definitions
##### production target
  Some `scala_library` or `java_library`
  Migrator writes production target for each package found under `src/main`
##### test target
  Some target that runs tests like `scala_specs2_junit_test`.
  Migrator writes test target for each package found under `src/test` or `src/it`
##### test support target
  Some `scala_library` with attribute `testonly = 1`
  Migrator writes test support target for each package which is under `src/test`, `src/it` or `src/e2e` but does not have any file that matches test pattern (prefix/suffix with `Test`,`IT` or `E2E`).
##### filegroup target
  Some `filegroup` which other targets can refer to and depend on the files, very useful for cycles (see next bullet)
##### I can't find a production/test/test suport target in my package/directory
  In cases where some packages have a cyclic dependency between them the migrator will write the production/test/test support target in their shared ancestor (i.e. if `com/wixpress/ecom/stores` and `com/wixpress/ecom/cart` packages have a cycle then the shared target will be in a BUILD.bazel file under `com/wixpress/ecom`)




##  Possible analysis failures
### (1) Prod code that depends on test code
##### PROBLEM
Sometimes we have production target that depends on test target (happens usually in testkits).
Migrator would code that dependency BUT bazel would fail the build with the following message:
```
ERROR: (...) in scala_library rule <production-target>: non-test target '<production-target>' depends on testonly target '<test-target>' and doesn't have testonly attribute set
```
##### EXPLANATION
In Bazel test (/test support) target can depend on production target **but not the other way around**.
##### SOLUTION
**Manual**: Tell Bazel that the **production target** is actually a **test support target** by simply adding the `testOnly = 1` attribute.
1. Locate the target in your workspace (usually `scala_library`) (link to how to)
2. Add the attribute `testOnly = 1`

**Automatic**: Let migrator know that this target is [testOnly](overrides.md#possible-attirbutes).

### (2) Missing symbols
##### PROBLEM
Compilation fails on missing symbols with one of the following errors:

- `object __ is not a member of package __`
- `error: not found: value __`

##### EXPLANATION
It indicates that the `deps` list of that target is incomplete.
We write internal dependencies according to Codota (code index) - and if Codota's index is outdated or lacking - the migrator's result would also be incomplete.
[You can also manually check what is indexed in Codota](#how-to-verify-what-was-indexed-as-dependencies-of-a-file).
Codota has no knowledge of a dependency if it has no representation in the bytecode (for example constants / parameters of annotations) and it isn't represented in the imports ( you're using `._`/`.*` imports or no imports since it's the same package).

Alternatively if you have scala code which depend on other scala code **generated** from proto and you depend in maven on `<classifier>proto</classifier>` this will also happen. 

##### SOLUTION
**Manual**: Locate the target of the missing symbol and add its label to `deps` of the failing target.

Note: this will only solve the issue for your current branch. you still have to fix this in a way that the migrator will know of this depedency as well for future migration branches. See "Automatic" below

**Automatic**:
Read this:
- [why codota failed to index](#troubleshooting-bad-codota-index)

**Proto related**:  
Remove `<classifier>proto</classifier>` and `<type>zip</type>` from the dependency, push, wait for TC to build and then re-run migration.

### (3) Missing additional generators for proto files
##### PROBLEM
Compilation fails on missing scala classes that are auto-generated by custom proto generators (e.g. `call_scope`):
<pre><code>
object MediaManagerGatewayWithCallScope is not a member of package com.wixpress.media.gateway.api
</code></pre>
##### SOLUTION
In [InternalTargetsOverrides](overrides.md#InternalTargetsOverrides
) add the following override:
`"additionalProtoAttributes": "additional_generators = { \"call_scope\": [], },"`
for the relevant proto target label.
see example in [server-infra](https://github.com/wix-private/server-infra/blob/master/bazel_migration/internal_targets.overrides#L8)

### (4) Maven dependency with RELEASE or LATEST version
##### PROBLEM
When pom files contain dependencies with dynamic versions such as RELEASE or LATEST:
e.g.:
```
        <dependency>
            <groupId>com.logentries</groupId>
            <artifactId>logentries-appender</artifactId>
            <version>RELEASE</version>
        </dependency>
```
##### EXPLANATION
The repository rule that downloads this dependency's jar fails to find this version in artifactory path.
More over, having a floating version is an anti-pattern in bazel, that seeks deterministic, reproducable builds.
##### SOLUTION
1. If the dependency is part of your repo - kindly change it to relevant explicit version:
e.g.:
find the version here:

```
        <dependency>
            <groupId>com.logentries</groupId>
            <artifactId>logentries-appender</artifactId>
            <version>3.2.1</version>
        </dependency>
```
2. If the dependency is transitive. You can solve it by defining the dependency directly in your pom with explicit version. you also need to exclude the artifact in the direct dependency in your pom file

e.g.:
Let's say ```annotations-java5``` is fetched transitvely by ```com.wixpress.common:foo```
in addition to adding an explicit dependency on ```annotations-java5``` (like in case 1.), you also need to add an exclusion:
```
<dependency>
    <groupId>com.wixpress.common</groupId>
    <artifactId>foo</artifactId>
    <exclusions>
       <exclusion>
           <groupId>org.jetbrains</groupId>
            <artifactId>annotations-java5</artifactId>
       </exclusion>
    </exclusions>
</dependency>
```

### (5) external repo dependency (core-server-build-tools) is out-of-date (local bazel run)
##### PROBLEM
Compilation fails to load files from external source repository (usually `core-server-build-tools`). e.g.:
<pre><code>
ERROR: Failed to load Skylark extension '@core_server_build_tools//:repositories.bzl'.
</code></pre>
##### EXPLANATION
For the time being, a wix repo is only source-dependent on latest commit of a few wix repositories. one of them `core-server-build-tools` - which contains important bazel rules and macros.

Each time you run bazel, a custom script is being run that generate a meta-data file (can be found in `tools/wix_external_repositories.bzl`) that contains the latest head depedency of a pre-defined list of wix-repositories.
If this file already exists, it will not be updated.
##### SOLUTION
remove the following file:
`rm tools/wix_external_repositories.bzl`
and run bazel again

## possible test failures
### (1) test target with no tests

##### PROBLEM
Test target fails with the following message in test log `Was not able to discover any classes for archive`. Example:
<pre><code>==================== Test output for (some-target):
/dev/shm/bazel-sandbox.e0d6a9590dd3180f8e40342aabc7c552/5993067211771649541/execroot/other/bazel-out/local-fastbuild/bin/billing-onboarding-service/src/test/scala/com/wixpress/billing/onboarding/onboarding.runfiles/other/billing-onboarding-service/src/test/scala/com/wixpress/billing/onboarding/onboarding: line 257: execpath: command not found
JUnit4 Test Runner
.E
Time: ...
There was 1 failure:
1) initializationError(io.bazel.rulesscala.specs2.Specs2DiscoveredTestSuite)
java.lang.IllegalStateException: <b>Was not able to discover any classes for archive</b>=[Ljava.lang.String;@397fbdb, prefixes=Set(Test), suffixes=Set(Test)
</code></pre>
another variant Example:
<pre><code>1) initializationError(io.bazel.rulesscala.specs2.Specs2DiscoveredTestSuite)
java.lang.IllegalStateException: Was not able to discover any classes for archive=[Ljava.lang.String;@130d63be, prefixes=Set(IT, E2E), suffixes=Set(IT, E2E)
</code></pre>
##### EXPLANATION #1
In the package there is a file with name that matches pattern `Test*` or `*Test` or `IT*` or `*IT` but inside that file there is no actual test class to run. This often happens with test support code like `TestAspectSupport.scala`.
Based on the filename, migrator falsely wrote a target that supposed to run test.
Other than such files no other files containing tests exist so Bazel errors out (if you have a mix of test support and tests that just works).

##### SOLUTION
**Manual**: Tell bazel that the target is actual just a test support target
1. Locate the problematic BUILD.bazel file and the target in your workspace ([how](#how-to-locate-the-definition-of-failing-test-target))
2. Add the attribute `testOnly = 1`

  example:
  ```
  # BUILD.bazel file
  scala_library(
    name = "some_target",
    srcs = glob(["*.scala"]),
    )
  ```
  would turn into:
  ```
  # BUILD.bazel file
  scala_library(
    name = "some_target",
    testOnly = 1,
    srcs = glob(["*.scala"]),
    )
  ```
**Automatic**: Use override to change the `testType` to `None` ([see here](overrides.md#internaltargetsoverrides))

##### EXPLANATION #2
If a test class is declared with Specs2 specification instead of SpecWithJUnit (or equivalent situation)

##### SOLUTION
Update test class to have JUnit support

### (2) tests that uses EmbeddedMySql/EmbeddedMongo
##### PROBLEM
**EXAMPLES to outputs:**
NOTE: we are still collecting examples to test failures but this section is relevant to any test target that uses mysql
<pre><code>com.wixpress.framework.test.env.ITEnvManagedServiceException: Failed to start managed testing service [ITEmbeddedMysql]
    at
    ...
    at com.wixpress.framework.test.env.AsyncCompositeManagedService.$anonfun$fanout$2(CompositeManagedService.scala:24)
<b>Caused by: java.lang.IllegalArgumentException: Could NOT create Directory /home/builduser/.embedmysql</b>
    at de.flapdoodle.embed.process.store.LocalArtifactStore.createOrCheckDir(LocalArtifactStore.java:62)
    ...
    at de.flapdoodle.embed.process.store.ExtractedArtifactStore.checkDistribution(ExtractedArtifactStore.java:60)
    at de.flapdoodle.embed.process.runtime.Starter.prepare(Starter.java:56)
    at de.flapdoodle.embed.process.runtime.Starter.prepare(Starter.java:49)
    at com.wix.mysql.EmbeddedMysql.<init>(EmbeddedMysql.java:41)
    at com.wix.mysql.EmbeddedMysql$Builder.start(EmbeddedMysql.java:169)
    at com.wixpress.mysql.ITEmbeddedMysql.doStart(ITEmbeddedMysql.scala:37)
    at com.wixpress.framework.test.env.InitGuardedManagedService.tryToStart(AbstractManagedService.scala:34)
</code></pre>

##### EXPLANATION
For sandboxed tests target that use embedded mysql or mongo - we [must specify additional attributes](#checklist-for-test-target-that-uses-embeddedmysqlembeddedmongo).

#####

### (3) tests are failing with timeout

##### PROBLEM
Test fails with output similar to the below:
//server/wix-campaigns-advertiser/wix-campaigns-advertiser-web/src/test/scala/com/wix/advertiser/ops:ops TIMEOUT in 61.0s

##### SOLUTION
Note: please make sure the timeout is indeed too low since using large timeouts will obviously slow down the build.  

Override manually - add the "size" attribute per https://docs.bazel.build/versions/master/be/common-definitions.html#common-attributes-tests

Override for migration - add the "testSize" attribute per https://github.com/wix-private/bazel-tooling/blob/master/migrator/docs/overrides.md#possible-attirbutes

### (4) tests are failing to read files from resources

##### PROBLEM 
Test fails with output similar to the below:
    
    java.io.FileNotFoundException, with message:
    file:/home/builduser/.cache/bazel/.../main/resources/libresources.jar!/emails_vmroot/email-template-it.vm (No such file or directory)"
    
###### What's going on?    
The test (or production code) is trying to read a classpath resource under `src/main/resources` (or `src/test/resource` etc.) as a file.
This works under maven where the resources are files, but under bazel the resources are packaged in a jar. 
They can be loaded using the classloader, but not as regular files.

##### SOLUTION
If the classpath resource is only loaded into test code, just load it from classpath. You can use Guavas `Resources` utility.
If your production code expects to read the resources as files, you will need to extract them to a temporary directory.

You can use the `ClasspathResource` object from `io-test-kit` module from the framework.

Add the following to your POM.xml:

```xml
   <dependency>
       <groupId>com.wixpress.framework</groupId>
       <artifactId>io-test-kit</artifactId>
       <scope>test</scope>
   </dependency>
```

Then, in your test environment setup code:

```scala
import com.wix.e2e.ClasspathResource
// for multiple resources
val resourceRoot = ClasspathResource.convertToFiles(
  "emails_vmroot/assets/locale/emails_en.json", 
  "emails_vmroot/email-template-it.vm"
  )
// for single resource
val pathToResourceFile = ClasspathResource.convertToFile("emails_vmroot/assets/locale/emails_en.json")
```
Pass the `resourceRoot` or `pathToResourceFile` to your production code, for example via config file (ERB).

### (5) tests are failing to read log files

##### PROBLEM 
Tests are failing to read logs due to Logback writing logs to `target/logs`

###### What's going on?    
The server logger is configured via `logback.xml` or `logback-test.xml`
While some projects configure their `logback-test.xml` to simply write to `STDOUT` - some configure this xml to write to file in filesystem (usually under `target/test-out` dir)

Bazel runs the tests in isolated environment and `./target/test-out` may not be available

##### SOLUTION
Our suggetion in this case is to change `logback-test.xml` to write to `${TEST_UNDECLARED_OUTPUTS_DIR}/some-file.log`. This dir gets archived after test execution ends and then you can view the log in the zip file under: `./bazel-out/darwin-fastbuild/testlogs/<package-name>/<target-name>/test.outputs/outputs.zip`

To make sure you are still comaptible with maven you can write `${TEST_UNDECLARED_OUTPUTS_DIR-./target/test-out}/some-file.log` and then logback would use bazel's `${TEST_UNDECLARED_OUTPUTS_DIR}` and if not found , will use `target/test-out`.

  **EXAMPLE:**
  ```xml
  <appender name="GENERAL_FILE_LOG" class="ch.qos.logback.core.FileAppender">
      <append>false</append>
      <file>${TEST_UNDECLARED_OUTPUTS_DIR-./target/test-out}/app-store-wix.general.log</file>
      <encoder>
          <pattern>%d{HH:mm:ss.SSS} %-5level class=[%logger{0}] %marker %msg%n</pattern>
      </encoder>
  </appender>
  ```

Also - if you happen to have a line that tries to load file from maven structure path: like `<include file="src/main/resources/logback-overrides.xml"/>`, you must replace it with `<include resource="logback-overrides.xml"/>` - so it will be loaded from classpath (as maven directory structure will not look the same on bazel tests runtime).

### (6) tests are failing because koboshi cannot write to cache directory

##### PROBLEM
Test fails with output similar to the below:
```scala
[com.wix.hoopoe.koboshi.cache.ReadOnlyTimestampedLocalCache]: Factory method 'petriResilientCache' threw exception; nested exception is java.lang.IllegalStateException: 
***************************************************************
cache folder /tmp/_tmp/4a2ad955f657ae1ad7600fe72f00d923/cache/wix/xxxx is a non writable directory
This may be because you are running in the dev environment but have not signalled it to be so.
Try "touch /home/builduser/.devEnv" to solve it.
See EnvironmentProvider for additional details
***************************************************************
```
###### What's going on?  
This tends to happen when you have an IT tests that starts more then 1 bootstrap server.
Becasue Bazel is fater, both servers attempt to write into the same koboshi folder and lock each other out

Another option : If this still happens it’s probably because you are running a bootstrap server in your own separate process. IF this is the case and with good reason then you need to pass in the `-Dwix.enviroment=CI` jvm argument. See this [example](https://github.com/wix-platform/wix-framework/pull/1746/).

Code in [charge](https://github.com/wix-platform/wix-framework/blob/master/environment-modules/wix-environment-provider/src/main/java/com/wixpress/framework/environment/ConfigurationEnvironmentProvider.java) - this works by default by the `--test_arg=--jvm_flags=-Dwix.environment=CI` that we added by default to all .bazelrc

##### SOLUTION
Adding a fakeManifest with specific artifact-ids - 
```
BootstrapManagedService(OneOfYourBootstrapServers, Options(
        port = Some(oneOfYourBootstrapServersPort),
        manifest = Some(FakeManifest.sample.copy(ImplementationArtifactId = "OneOfYourBootstrapServersArtifactId").toPath)
      ))
```
This affects the cache folder path and prevents the collision

### (7) tests are failing with insufficient memory 

##### PROBLEM
Test fails with output similar to the below:
```scala
# There is insufficient memory for the Java Runtime Environment to continue.
# Native memory allocation (mmap) failed to map 110624768 bytes for committing reserved memory.
# An error report file with more information is saved as: ......
```

##### SOLUTION
Override manually - add the "size" attribute per https://docs.bazel.build/versions/master/be/common-definitions.html#common-attributes-tests

Override for migration - add the "testSize" attribute per https://github.com/wix-private/bazel-tooling/blob/master/migrator/docs/overrides.md#possible-attirbutes

### (8) tests are failing with java.net.UnknownHostException when com.mongodb.MongoClient is trying to connect to mongo, which is running as a docker container

##### PROBLEM
In bazels network configuration, every docker container exposes it's hostname as it's original name. For ex, if the container was named `mongodb-8T5CUgtL6trgfmfM0BDB`, it's hostname will be the same. Now `MongoClient`, when given hostname to connect to, does `hostname.toLowerCase()` under the hood. So if your container name contains at least one uppper case, `MongoClient` will fail to connect to it.  

##### SOLUTION
Make sure your docker container is named using lower cases only.

### (9) tests are failing with java.lang.ClassFormatError: Absent Code attribute in method that is not native or abstract in class file

##### PROBLEM
This happens when a macro code is built with scala_library rule

##### SOLUTION
Change the code to be built via scala_macro_library rule.
Manual:  
Change the `scala_library` call to `scala_macro_library` in the relevant BUILD.bazel file
Automatic:  
Add the below to post_migraiton.sh:
buildozer 'set kind scala_macro_library' <target>

## Additional issues (Fill in solutions)
- Tests need ~~`mysql`~~ or `mongo`
- Tests that run docker
- IT that was wrongfully tagged as UT - port in use, parallelization, cannot open socket etc...
- tmp directory is too long
- Missing symbol
   - Was supposed to get there from third party but was filtered out
   - Codota is not refreshed with latest code
   - wildcard import with custom types
- test is too small
- Unidentified tests

## How to locate the defintion of target that fails to compile:
1. Locate the first location of `ERROR:` just before the failure in the log
    <pre><code>ERROR: <b>/full/path/to/build/BUILD.bazel</b> :12:1: scala //foo/bar:<b>target_name</b> failed (Exit 1)</code></pre>
2. The path to BUILD.bazel file is given.
3. Inside look for the rule according to the label

## How to locate the definition of failing test target
1. Locate the first location of `==================== Test output for **(some-label)**:`` **above** the failure message
    <pre><code>
    ==================== Test output for <b>//some/package:some-target</b>:
    12:06:55 JUnit4 Test Runner
    12:06:55 .E
    12:06:55 Time: 0.021
    12:06:55 There was 1 failure:
    12:06:55 1) initializationError(io.bazel.rulesscala.specs2.Specs2DiscoveredTestSuite)
    12:06:55 java.lang.IllegalStateException: Was not able to discover any classes for archive=[Ljava.lang.String;@179ece50, prefixes=Set(IT, E2E), suffixes=Set(IT, E2E)
    12:06:55 at io.bazel.rulesscala.test_discovery.PrefixSuffixTestDiscoveringSuite$.discoverClasses(DiscoveredTestSuite.scala:51)
    12:06:55 at io.bazel.rulesscala.specs2.Specs2PrefixSuffixTestDiscoveringSuite.<init>(Specs2RunnerBuilder.scala:25)
    12:06:55 at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
    12:06:55 at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
    </code></pre>
2. From the label you can understand the location of the BUILD.bazel file and the name of the target:
    For label //some/foo/bar:baz
    - The location of the BUILD.bazel file is <span><code>(repo-root)/<b>some/foo/bar</b>/BUILD.bazel</code></span>
    - The name of the target is `"baz"`

## How to verify what was indexed as dependencies of a file
1. In Jenkins - open **02-Debugging** tab
2. Go to **Deps of Specific File by 
**
3. Click "Build with Parameters"
4. Supply parameters:
   * **module_relative_path** - relative path to **maven** module (where the file located) from repository root
   * **use_tests** - mark if the file is under `src/test` or `src/it` folders and not under `src/main`
   * **relative_file_path** - the relative file path (for instance `com/wixpress/bootstrap/jetty/JettyBasedServer.scala`)
   * **skip_classpath** - check only if you want to see the results of the last migration run. If you made changes and want to see the new results by codota - please uncheck it
5. Look under the logs for results
6. Missing some deps?

## Troubleshooting bad codota index
1) Check that the module is green in JVM-TC
    - **If it's red - fix that module!**


2) Check that the module / the dependencies produce `sources` jar or `test-sources` jar
    - Go to artifactory: (for groupId:`some.group` artifactId:`artifactId` version:`1.0-SNAPSHOT`) [https://repo.dev.wixpress.com/artifactory/libs-snapshots/some/group/artifactId/1.0-SNAPSHOT/]()
    - See if you can find there `sources` jar or `test-sources` jar and check that the last updated timestamp makes sense.
    - If you can't find `sources` or `test-sources` jar check the following:
      - make sure the maven module inherits from `base-parent`:
        ```xml
        <parent>
          <groupId>com.wixpress.common</groupId>
          <artifactId>wix-scala-parent-ng</artifactId>
          <version>100.0.0-SNAPSHOT</version>
          <relativePath/>
        </parent>
        ```
        OR
        ```xml
        <parent>
          <groupId>com.wixpress.common</groupId>
          <artifactId>wix-java-parent-ng</artifactId>
          <version>100.0.0-SNAPSHOT</version>
          <relativePath>../wix-java-parent-ng</relativePath>
        </parent>
        ```
        OR
        ```xml
        <parent>
          <groupId>com.wixpress.common</groupId>
          <artifactId>wix-base-parent-ng</artifactId>
          <version>100.0.0-SNAPSHOT</version>
          <relativePath>../wix-base-parent-ng</relativePath>
        </parent>
        ```
      - make sure you don't have custom configuration to `maven-sources-plugin` or `maven-jar-plugin` (NEED TO ADD CODE EXAMPLE?)



3) Dependencies relation can be **sometimes** missed when either:
  - using wildcard import
  - when using symbols of the same package without explicitly importing them.
    - example of such a case is spring xml files.

    **If you have such case - please report to us (so we can generelize it and solve it in the future), but for quick fix**
  - add explicit imports to the missing symols
  - After green CI, wait ~5 more minutes so Codota would index the changes
  - (if you want to make sure - use the debugging job to verify that the deps of that module was changed)

## Checklist for test target that uses EmbeddedMySql/EmbeddedMongo:
First, you must use ITEmbeddedMysql (and not wix-embedded-mysql directly) / must use ITEmbeddedMongo (and not the deprecated EmbeddedMongo).
See fw’s [mysql readme](https://github.com/wix-platform/wix-framework/tree/master/test-infrastructures-modules/mysql-testkit) or [mongo readme](https://github.com/wix-platform/wix-framework/tree/master/test-infrastructures-modules/mongo-test-kit).
<br>Test targets that use EmbeddedMySQL/Mongo must be declared in [**overrides mechanism**](overrides.md#possible-attirbutes) with the following:
- [ ] Test target must set `additionalDataDeps`:
  - `@mysql_default_version//:binary`- [example](https://github.com/wix-private/promote/blob/master/bazel_migration/internal_targets.overrides#L99)
  - `@mongo_default_version//:binary`- [example](https://github.com/wix-private/users/blob/67b5abea1aeedca3e05d04b615cf9e534928d75c/bazel_migration/internal_targets.overrides#L261)
  - Note - you can also edit this in place in the actual BUILD file like [mysql example](https://github.com/wix-platform/wix-framework/blob/8e98b032762d9e9cbe19c587adeb4bf1a605792d/test-infrastructures-modules/mysql-testkit/src/it/scala/com/wixpress/mysql/BUILD.bazel#L11) or [mongo example](https://github.com/wix-platform/wix-framework/blob/8e98b032762d9e9cbe19c587adeb4bf1a605792d/mongo-modules/wix-mongo-config/src/it/scala/com/wixpress/mongo/BUILD.bazel#L10) if you wish to run a build on a brnach without running migration - make sure you add only the deafult tag OR a specific verison, no need for both. See here on how to [run this for your specifc target](troubleshooting-sandbox-failures.md#i-want-to-run-only-1-step-with-sandboxing).

**But wait, I need a custom mysql version, what do I do?** Test targets that use a **custom** mysql version need to declare:
- [ ] Use the correct [ITEmbeddedMysql c'tor](https://github.com/wix-platform/wix-framework/blob/9cf60b8468d9a0d6c2389d3c6ff7bbe882efe567/test-infrastructures-modules/mysql-testkit/src/it/scala/com/wixpress/mysql/EmbeddedMysqlIT.scala#L55)
- [ ] Test target must set `additionalJvmFlags` with an additional flag:
  - `-Dexample.custom.mysql.version=$(location @mysql_5.6_latest//:binary)` (replace 5.6_latest with your version)
- [ ] Test target must set `additionalDataDeps`:
  - `mysql_5.6_latest//:binary` (replace 5.6_latest with your version)
- Example [test target](https://github.com/wix-platform/wix-framework/blob/3a27ec707becf291fddb073b0bc62720e9f00d00/bazel_migration/internal_targets.overrides#L87) (note that this sets 2 versions of mysql, you will most probably need ONLY ONE).

**But wait, I need a custom mongo version, what do I do?** Test targets that use a **custom** mongo version need to declare:
- [ ] Use the correct [ITEmbeddedMongo c'tor](https://github.com/wix-platform/wix-framework/blob/4d97fc0f22c65140ca9d748ac9412be2c4a2db52/test-infrastructures-modules/mongo-test-kit/src/it/scala/com/wixpress/framework/test/embeddedMongo/EmbeddedMongoWithDownloadConfigIT.scala#L24)
- [ ] Test target must set `additionalJvmFlags` with an additional flag:
  - `-Dexample.custom.mongo.version=$(location @mongo_3.3.1//:binary)` (replace 3.3.1 with your version)
- [ ] Test target must set `additionalDataDeps`:
  - `@mongo_3.3.1//:binary` (replace 3.3.1 with your version)
- Example [test target](https://github.com/wix-platform/wix-framework/blob/4d97fc0f22c65140ca9d748ac9412be2c4a2db52/bazel_migration/internal_targets.overrides#L15) (note that this sets 2 versions of mongo, you will most probably need ONLY ONE).


**Why is this good for you** / why you should fix this even if it's only failing in your sandbox step:
* If your ITs are passing in remote execution then usually the sandbox failure just means you're not downloading your dependencies up front. This means, for example, every test run will download 350MB of MySQL installer since you didn’t declare it properly --> slower build.<br>
In the near future RBE beahviour will be fixed so that it has full network sandboxing, and then your tests will start failing there too.
* Additionaly, once we all start developing locally with the fully sandboxed and parallelized `bazel test //...`, these tests will fail lcoally for you too.<br>
The only theortical way to workaround this would have been to make `block_network = false` by default, which would cancel out all the hermeticity beauty we gain from bazel.


**Additionally** - if the migrator thinks the test is Unit Test (it was named with `Test` prefix/suffix) - it is recommended to change it to IT or E2E (name wise and probably also location wise just for clarity). If you really insist on leaving the test as Unit Test - you should at least use the [**overrides mechanism**](overrides.md#possible-attirbutes) to set the `tags` to `ITE2E`.

**Example to overrides needed for target under unit test the needs EmbeddedMySQL:**:

  ```json
      {
        "label": "//foo/bar/src/it/scala/com/example:mysql",
        "additionalDataDeps": [
          "@mysql_default_version//:binary",
        ],
        "tags": "ITE2E"
      }
  ```


## Running bazel build on results in `File name too long`:

1. For some projects running `bazel build //...` may result in `File name too long`. If you open the offending BUILD.bazel 
file you can see name for the library (`agg=...`) is really long. This means that there is a big cycle between some of 
the packages in your build.  
2. You can use the `newName` in [**overrides mechanism**](overrides.md#possible-attirbutes) to replace the sythetic name with a shorter one, or you can try to remove the cycle from your code or make it smaller.    
NOTE: If you use the override you're likely to experience performance problems in Bazel once we move to it since the target is very coarse grain (less parallelism and cache hits)


## Locally running `bazel build` or `bazel test` results in  
```
Worker process quit or closed its stdin stream when we tried to send a WorkRequest:
...
...
...
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
at java.lang.Thread.run(Thread.java:748)
```
Run `bazel version` and make sure that you are running the latest Bazel stable release (at the time of writing this `0.10.1`). 
